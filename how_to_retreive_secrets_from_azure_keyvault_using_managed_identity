#Install pip for Python 2.7
wget https://bootstrap.pypa.io/pip/2.7/get-pip.py
python get-pip.py

#Install azure modules for identity and keyvault-secrets
pip install azure-keyvault-secrets azure-identity

#Download the file "azure_keyvault_secret.py" to the ansible lookup module directory
cd /usr/share/ansible/plugins/lookup && wget https://github.com/Azure/azure_preview_modules/blob/master/lookup_plugins/azure_keyvault_secret.py

#Create playbook to retreive secrets from keyvalut 
cat > retreive_secret_playbook.yml << EOF
---
- hosts: localhost
  gather_facts: false
  connection: local
  tasks:
    - name: Look up secret when ansible host is general VM
      vars:
        url: 'https://rg-onlyadmins-kv.vault.azure.net/'
        secretname: 'root'
      debug: msg="the value of this secret is {{lookup('azure_keyvault_secret',secretname,vault_url=url)}}"
EOF
